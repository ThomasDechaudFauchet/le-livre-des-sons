<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Étude 002 — Spatialisation (Gauche – Droite)</title>
  <link rel="stylesheet" href="../../style.css?v=1">
</head>

<body>
  <main class="wrap">

    <header>
      <div class="site-title">Le Livre des Sons</div>
      <div class="site-subtitle">
        Principes synesthésiques entre la forme visuelle et l'objet sonore
      </div>
    </header>

    <h1 class="study-title">Étude 002 : Spatialisation (Gauche – Droite)</h1>

    <div class="cat">Étude laborieuse</div>

    <!-- Zone d’écoute -->
    <div class="audio-block">

      <p>Écoute — deux situations sonores</p>

      <!-- Choix des parties -->
      <ul class="track-list" id="trackList">
  <li>
    <a href="#" data-src="../../audio/002-1.mp3" onclick="return selectTrack(this);">
      Partie 1 — Déplacement gauche → droite (24 s)
    </a>
  </li>
  <li>
    <a href="#" data-src="../../audio/002-2.mp3" onclick="return selectTrack(this);">
      Partie 2 — Focalisation spatiale (12 s)
    </a>
  </li>
</ul>

      <!-- Player unique -->
     <audio id="player" preload="metadata"></audio>

<div class="controls">
  <button class="ctrl" id="btnPlay" type="button">▶ Lire</button>
  <button class="ctrl" id="btnPause" type="button">⏸ Pause</button>
</div>

    </div>

    <nav>
      <a href="../001/">← Étude précédente</a>
      <a href="../../">Sommaire</a>
      <a href="#">Étude suivante →</a>
    </nav>

  </main>

<script>
let audioCtx;
let gainNode;
let sourceNode;
const player = document.getElementById('player');

function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    sourceNode = audioCtx.createMediaElementSource(player);
    gainNode = audioCtx.createGain();

    gainNode.gain.setValueAtTime(0, audioCtx.currentTime);

    sourceNode.connect(gainNode);
    gainNode.connect(audioCtx.destination);
  }
}

/* Fade utils */
function fadeTo(value, duration = 0.3) {
  const now = audioCtx.currentTime;
  gainNode.gain.cancelScheduledValues(now);
  gainNode.gain.setValueAtTime(gainNode.gain.value, now);
  gainNode.gain.linearRampToValueAtTime(value, now + duration);
}

/* Sélection d’une piste (sans autoplay) */
function selectTrack(link) {
  initAudio();

  const src = link.getAttribute('data-src');

  document.querySelectorAll('#trackList a')
    .forEach(a => a.classList.remove('is-active'));
  link.classList.add('is-active');

  // Fade-out AVANT changement
  fadeTo(0, 0.25);

  // Changement de source APRÈS fade-out
  setTimeout(() => {
    player.pause();
    player.src = src;
    player.load();
  }, 260);

  return false;
}

/* Fade-in UNIQUEMENT quand l’utilisateur lance la lecture */
player.addEventListener("play", () => {
  initAudio();
  fadeTo(1, 0.3);
});

/* Fade-out propre avant pause */
player.addEventListener("pause", () => {
  if (!gainNode || !audioCtx) return;
  fadeTo(0, 0.25);
});
</script>
</body>
</html>
